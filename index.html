<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Snow Signal — Search</title>
<style>
  :root{--bg:#0b0f14;--panel:#111923;--text:#e3eef7;--muted:#9fb1c6;--chip:#182333;--border:#203043;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:900px;margin:32px auto;padding:0 16px}
  h1{margin:0 0 12px;font-size:24px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
  input{flex:1;background:var(--chip);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:12px}
  ul{list-style:none;margin:0;padding:0}
  li{border:1px solid var(--border);background:var(--chip);border-radius:12px;margin:8px 0}
  a{display:block;padding:12px 14px;color:var(--text);text-decoration:none}
  a:hover{background:#1a2a3d}
  .muted{color:var(--muted);font-size:13px;margin-top:10px}
  .err{color:#ffb4b4}
</style>
</head>
<body>
<div class="wrap">
  <h1>❄️ Snow Signal</h1>
  <div class="panel">
    <div class="row"><input id="search" placeholder="Search ski resort…" /></div>
    <ul id="list"></ul>
    <div id="msg" class="muted">Loading resorts…</div>
    <div id="err" class="err"></div>
  </div>
</div>

<!-- Papa Parse (tiny, safe CSV parser) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGijpvcmz6TA1HWmDc4njQx7vS0gZ4WSfUrw2EgLT9_aVOX3LFfyIL3datSI9gVswmUadZuHoGx6Hw/pub?output=csv"; 
// Example format: 
// https://docs.google.com/spreadsheets/d/e/XXXXXXXX/pub?gid=0&single=true&output=csv
const COL_RESORT = "skiresort"; // exact sheet header (case-insensitive)

const $ = id => document.getElementById(id);
const elList = $("list"), elMsg = $("msg"), elErr = $("err"), elSearch = $("search");
const lower = s => (s||"").toString().trim().toLowerCase();

function renderList(names){
  elList.innerHTML = names.map(n => `<li><a href="resort.html?resort=${encodeURIComponent(n)}">${n}</a></li>`).join("");
  elMsg.textContent = names.length ? "" : "No resorts found.";
}

function onError(txt){
  elErr.textContent = txt;
  elMsg.textContent = "";
}

async function loadCSV(){
  try{
    // Quick reachability check first
    const head = await fetch(CSV_URL, { method:"GET", cache:"no-store" });
    if(!head.ok){ throw new Error("Sheet fetch failed: " + head.status); }
    const csvText = await head.text();

    const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
    if (parsed.errors && parsed.errors.length){
      console.warn(parsed.errors);
    }
    const rows = parsed.data;
    if (!rows || !rows.length){ elMsg.textContent = "No data."; return; }

    // find column index case-insensitively
    const headers = parsed.meta.fields || [];
    const iResortHdr = headers.find(h => lower(h) === lower(COL_RESORT));
    if (!iResortHdr){ onError(`Missing header: ${COL_RESORT}`); return; }

    const names = Array.from(new Set(rows.map(r => r[iResortHdr]).filter(Boolean)))
      .sort((a,b)=>a.localeCompare(b));
    renderList(names);

    elSearch.addEventListener("input", e=>{
      const q = lower(e.target.value);
      const filtered = names.filter(n => lower(n).includes(q));
      renderList(filtered);
    });

    elMsg.textContent = "";
  }catch(err){
    console.error(err);
    onError("Failed to load sheet. Check the published CSV link (must include output=csv).");
  }
}

window.addEventListener("load", loadCSV);
</script>
</body>
</html>
