<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
/* ==== LIVE CSV (no publish needed) ==== */
const SHEET_ID   = "1yfgTn0nAwJolJzyZN9kF7NLWjItQRe8Kl3OQYQhX2iM";   // your sheet id
const SHEET_NAME = "Sheet1";                                         // exact tab name
const CSV_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-1vTGijpvcmz6TA1HWmDc4njQx7vS0gZ4WSfUrw2EgLT9_aVOX3LFfyIL3datSI9gVswmUadZuHoGx6Hw/pub?output=csv`;

/* Expected logical columns (we'll resolve headers case-insensitively) */
const NEED = {
  skiresort:"skiresort",
  seasonsnow:"seasonsnow", last24hr:"last24hr", last72hr:"last72hr",
  snow24h:"snow24h", tmrsnow:"tmrsnow","3snow":"3snow","4snow":"4snow","5snow":"5snow","6snow":"6snow","7snow":"7snow",
  openingday:"openingday",
  rating_td:"rating_td", rating_tmr:"rating_tmr", rating_day3:"rating_day3",
  reason_td:"reason_td", reason_tmr:"reason_tmr", reason_day3:"reason_day3"
};

const $ = id => document.getElementById(id);
const lower = s => (s??"").toString().trim().toLowerCase();
const toNum = v => { const m = String(v ?? "").replace(",", "").match(/-?\d+(\.\d+)?/); return m ? Number(m[0]) : 0; };
const nice = n => (isFinite(n) ? n.toFixed(1) : "0.0");
const dPlus = i => new Date(Date.now() + i*86400000).toLocaleDateString(undefined,{month:"short",day:"numeric"});

function ratingStyle(r){
  const key = lower(r);
  const pct = {"poor":18,"fair":40,"good":68,"excellent":88,"all time":100}[key] ?? 0;
  const col = {
    "poor":"#ef4444","fair":"#f59e0b","good":"#84cc16","excellent":"#22c55e","all time":"#16a34a"
  }[key] ?? "#9ca3af";
  return {h: Math.max(6,pct), color: col};
}

function setRating(barId, textId, reasonId, rating, reason){
  const {h, color} = ratingStyle(rating);
  const bar = $(barId);
  bar.style.height = h + "%";
  bar.style.background = color;
  $(textId).textContent = rating ? rating.replace(/\b\w/g,c=>c.toUpperCase()) : "—";
  $(reasonId).textContent = reason || "";
}

async function main(){
  const resortQ = new URLSearchParams(location.search).get("resort") || "";
  $("title").textContent = resortQ || "Ski Resort";
  $("updated").textContent = new Date().toLocaleString();
  if(!resortQ){ alert("Add ?resort=Name to the URL."); return; }

  const r = await fetch(CSV_URL, {cache:"no-store"});
  const csv = await r.text();
  const parsed = Papa.parse(csv, {header:true, skipEmptyLines:true});

  // Build a case-insensitive header map
  const fields = parsed.meta.fields || [];
  const hmap = {}; fields.forEach(h => { hmap[lower(h)] = h; });

  // Resolve each needed header to the actual header in the file
  const H = {};
  for (const [k, wanted] of Object.entries(NEED)) {
    const actual = hmap[lower(wanted)];
    H[k] = actual || null;
  }

  const rows = parsed.data || [];
  // Match resort row (trim + case-insensitive)
  const row = rows.find(x => H.skiresort && lower(x[H.skiresort]) === lower(resortQ));
  if(!row){ alert(`Resort "${resortQ}" not found in ${SHEET_NAME}.`); return; }

  $("title").textContent = row[H.skiresort] || resortQ;

  // OPEN/CLOSED badge
  const status = (H.openingday && row[H.openingday] || "").toString().trim().toUpperCase();
  const open = status === "OPEN";
  const badge = document.getElementById("openBadge");
  badge.textContent = open ? "OPEN" : (status || "STATUS N/A");
  badge.className = "badge " + (open ? "open" : "closed");

  // Left info
  $("season").textContent = H.seasonsnow ? nice(toNum(row[H.seasonsnow])) : "—";
  $("last24").textContent = H.last24hr   ? nice(toNum(row[H.last24hr]))   : "—";
  $("last72").textContent = H.last72hr   ? nice(toNum(row[H.last72hr]))   : "—";

  // 7 buckets: Next 24h + D+1..D+6
  const seq = [
    {key: H.snow24h, label: "Next 24h"},
    {key: H.tmrsnow, label: dPlus(1)},
    {key: H["3snow"], label: dPlus(2)},
    {key: H["4snow"], label: dPlus(3)},
    {key: H["5snow"], label: dPlus(4)},
    {key: H["6snow"], label: dPlus(5)},
    {key: H["7snow"], label: dPlus(6)},
  ].filter(s => !!s.key);

  const vals = seq.map(s => toNum(row[s.key]));
  const max = Math.max(6, ...vals);
  document.getElementById("bars").innerHTML = seq.map((s,i)=>{
    const v = vals[i];
    const h = (v / max) * 160;
    return `
      <div class="barwrap">
        <div class="bar" style="height:${h}px"></div>
        <div class="bar-lbl">${s.label}</div>
        <div class="bar-inch">${nice(v)} in</div>
      </div>`;
  }).join("");

  // Ratings (same rating => same color)
  setRating("rbar-td",  "rt-td",  "rs-td",  (H.rating_td  ? row[H.rating_td]  : ""), (H.reason_td  ? row[H.reason_td]  : ""));
  setRating("rbar-tmr", "rt-tmr", "rs-tmr", (H.rating_tmr ? row[H.rating_tmr] : ""), (H.reason_tmr ? row[H.reason_tmr] : ""));
  setRating("rbar-d3",  "rt-d3",  "rs-d3",  (H.rating_day3? row[H.rating_day3]: ""), (H.reason_day3? row[H.reason_day3]: ""));
}

window.addEventListener("load", main);
</script>
