<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Snow Signal — Resort</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  :root{
    /* Midnight glacier theme */
    --bg:#0a1018;
    --bg2:#0c1320;
    --panel:#101a28;
    --frost:rgba(255,255,255,.07);
    --frost-brd:rgba(255,255,255,.12);
    --ring:rgba(124,201,255,.25);
    --text:#e7f2ff;
    --muted:#a6bfd9;

    --ice:#8ec9ff;
    --mint:#59e3bd;
    --glow:#6ea8ff;

    --ok:#35d677;
    --warn:#f6b84c;
    --danger:#ef6464;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:
      radial-gradient(1200px 800px at 10% -20%, #13223b 0%, transparent 60%),
      radial-gradient(1000px 800px at 120% 20%, #0c1422 0%, transparent 55%),
      linear-gradient(180deg, var(--bg2) 0%, var(--bg) 60%);
    background-attachment: fixed;
  }
  .noise{position:fixed;inset:-20%;pointer-events:none;opacity:.05;mix-blend-mode:overlay;
    background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="4"/><feColorMatrix type="saturate" values="0"/></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');
    animation:grain 7s steps(10) infinite;
  }
  @keyframes grain{0%{transform:translate(0,0)}50%{transform:translate(-1%,1%)}100%{transform:translate(0,0)}}

  .wrap{max-width:1200px;margin:26px auto 64px;padding:0 18px}

  /* Header row */
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:8px 0 18px}
  .title{font-size:64px; font-weight:900; line-height:1.05; letter-spacing:.2px; margin:0;
    text-shadow:0 6px 28px rgba(110,168,255,.15);
  }
  .badge{
    padding:10px 18px;border-radius:999px;font-weight:800;letter-spacing:.8px;text-transform:uppercase;
    background:linear-gradient(180deg, rgba(53,214,119,.22), rgba(53,214,119,.10));
    border:1px solid rgba(53,214,119,.45); color:#d9ffea;
    box-shadow:0 0 0 0 rgba(53,214,119,.30), 0 12px 26px rgba(0,0,0,.25);
    backdrop-filter: blur(8px);
    animation:pulse 3s infinite;
  }
  .badge.closed{
    background:linear-gradient(180deg, rgba(239,100,100,.22), rgba(239,100,100,.10));
    border-color:rgba(239,100,100,.45); color:#ffe9e9; animation:none
  }
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(53,214,119,.30)} 70%{box-shadow:0 0 0 20px rgba(53,214,119,0)} 100%{box-shadow:0 0 0 0 rgba(53,214,119,0)}}

  /* Grid row: left stats / right map */
  .row{display:grid;grid-template-columns:1.15fr .85fr; gap:28px}
  @media (max-width:1000px){.row{grid-template-columns:1fr}}

  .panel{
    background:linear-gradient(180deg, var(--frost), rgba(255,255,255,.035));
    border:1px solid var(--frost-brd);
    border-radius:20px; padding:18px 18px 16px;
    box-shadow:
      0 16px 40px rgba(0,0,0,.35),
      inset 0 1px 0 rgba(255,255,255,.04);
    backdrop-filter: blur(8px);
  }
  h2{margin:6px 0 12px; font-size:22px; letter-spacing:.3px}
  .subcap{color:var(--muted); font-size:14px; margin-top:-2px}

  /* Recent snow stats */
  .stats3{display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-top:6px}
  .stat{
    background:linear-gradient(180deg, rgba(142,201,255,.10), rgba(142,201,255,.04));
    border:1px solid rgba(142,201,255,.18);
    border-radius:14px; padding:14px 14px 12px;
    box-shadow:0 10px 28px rgba(18,30,50,.35), inset 0 1px 0 rgba(255,255,255,.05);
  }
  .stat .k{font-size:12px; color:#bcd0e7; text-transform:uppercase; letter-spacing:.9px}
  .stat .v{margin-top:6px; font-size:28px; font-weight:900}

  /* Season hero */
  .seasonhero{
    margin-top:16px;
    background:
      radial-gradient(120px 60px at 15% 0%, rgba(142,201,255,.25), transparent 70%),
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid rgba(142,201,255,.22);
    border-radius:18px;
    padding:18px;
    display:flex; align-items:center; justify-content:space-between; gap:16px;
    box-shadow: 0 16px 42px rgba(110,168,255,.18), inset 0 1px 0 rgba(255,255,255,.05);
  }
  .seasonhero .label{font-size:16px; color:#cfe2fb; text-transform:uppercase; letter-spacing:.9px}
  .seasonhero .value{font-size:48px; font-weight:900; letter-spacing:.5px; text-shadow:0 8px 28px rgba(110,168,255,.25)}
  @media (max-width:520px){ .seasonhero .value{font-size:40px} }

  /* Map */
  .mapbox{height:300px; border-radius:18px; overflow:hidden; background:#0f1724;
    outline:1px solid rgba(142,201,255,.18);
    box-shadow:0 12px 34px rgba(0,0,0,.35), 0 0 0 6px rgba(110,168,255,.06) inset;
  }

  /* Sections */
  .section{margin-top:36px}
  .bigcap{font-size:44px; font-weight:900; margin:0 0 12px; text-shadow:0 6px 26px rgba(110,168,255,.15)}
  .hint{color:var(--muted); font-size:13px; margin-bottom:10px}

  /* Bars */
  .bars{display:flex; gap:28px; flex-wrap:wrap; align-items:flex-end; padding-bottom:10px}
  .barwrap{display:flex; flex-direction:column; align-items:center; gap:8px; width:110px}
  .barbox{height:220px; width:72px; display:flex; align-items:flex-end; justify-content:center}
  .bar{
    width:72px; border-radius:12px 12px 0 0;
    background:linear-gradient(180deg, rgba(142,201,255,.55), rgba(142,201,255,.12));
    outline:1px solid rgba(142,201,255,.28);
    box-shadow:0 10px 24px rgba(110,168,255,.22), inset 0 -10px 18px rgba(255,255,255,.06);
    transition: transform .2s ease, box-shadow .2s ease, outline-color .2s ease;
  }
  .barwrap:hover .bar{ transform:translateY(-6px); box-shadow:0 14px 30px rgba(110,168,255,.32), inset 0 -12px 20px rgba(255,255,255,.08); outline-color: rgba(110,168,255,.45) }

  .bar-label{font-size:14px; font-weight:800}
  .bar-inch{font-size:14px; color:var(--muted)}

  /* Stoke bars */
  .sbar{
    width:72px; border-radius:12px 12px 0 0;
    outline:1px solid rgba(255,255,255,.16);
    box-shadow:0 10px 24px rgba(0,0,0,.26), inset 0 -10px 18px rgba(255,255,255,.06);
    transition: transform .2s ease, box-shadow .2s ease, outline-color .2s ease;
  }
  .barwrap:hover .sbar{ transform:translateY(-6px); box-shadow:0 14px 30px rgba(0,0,0,.32), inset 0 -12px 20px rgba(255,255,255,.08); outline-color: rgba(255,255,255,.28) }
  .rating-text{font-size:15px; font-weight:900}
  .reason{font-size:13px; color:var(--muted); min-height:18px}

  /* Footer */
  footer{margin:42px 0 10px; color:var(--muted); font-size:12px; text-align:center}
  a{color:var(--ice)}
</style>
</head>
<body>
<div class="noise"></div>

<div class="wrap">
  <header>
    <h1 class="title" id="title">Ski Resort</h1>
    <div class="badge" id="badge">Open</div>
  </header>

  <div class="row">
    <!-- Left column: recent snow + season hero -->
    <section class="panel">
      <h2>Recent Snow</h2>
      <div class="stats3">
        <div class="stat"><div class="k">Last 24 hours</div><div class="v" id="last24">x in</div></div>
        <div class="stat"><div class="k">Last 72 Hours</div><div class="v" id="last72">x in</div></div>
        <div class="stat"><div class="k">Last 7 days</div><div class="v" id="last7">x in</div></div>
      </div>

      <div class="seasonhero">
        <div class="label">Season Total</div>
        <div class="value" id="seasonValue">0 in</div>
      </div>
    </section>

    <!-- Right column: Map -->
    <section class="panel">
      <h2>Map</h2>
      <div id="map" class="mapbox"></div>
    </section>
  </div>

  <!-- 7 Day Outlook -->
  <section class="section">
    <h3 class="bigcap">7 Day Outlook</h3>
    <div class="hint">Today, Tomorrow, then next 5 dates • Bars scale to the biggest day</div>
    <div class="panel">
      <div class="bars" id="snowBars"></div>
    </div>
  </section>

  <!-- 7 Day Stoke Rating -->
  <section class="section">
    <h3 class="bigcap">7 Day Stoke Rating</h3>
    <div class="hint">Mapped from your sheet’s rating fields</div>
    <div class="panel">
      <div class="bars" id="stokeBars"></div>
    </div>
  </section>

  <footer>Powered by <strong>Pow Signal</strong></footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
/* --------- CONFIG --------- */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGijpvcmz6TA1HWmDc4njQx7vS0gZ4WSfUrw2EgLT9_aVOX3LFfyIL3datSI9gVswmUadZuHoGx6Hw/pub?output=csv";

/* --------- Helpers --------- */
const $ = id=>document.getElementById(id);
const lower = s => (s==null?"":String(s)).trim().toLowerCase();
const toNum = v => { const s = String(v==null?"":v).replace(/,/g,""); const n = parseFloat(s.replace(/[^0-9.+-]/g,"")); return isNaN(n)?0:n; };
const nice = n => (isFinite(n) ? (Math.abs(n)>=100? n.toFixed(0) : n.toFixed(1)) : "0");
const labelDate = i => new Date(Date.now()+i*86400000).toLocaleDateString(undefined,{month:"short",day:"numeric"});
const isoDate = i => new Date(Date.now()+i*86400000).toISOString().slice(0,10);

/* Map rating words to height/color */
function ratingMeta(r){
  const k = lower(r||"");
  const pct = { "poor":18, "fair":42, "good":68, "excellent":88, "all time":100, "closed": 8 }[k] ?? 0;
  const col = {
    "poor":"#ef6464",
    "fair":"#f6b84c",
    "good":"#84e05f",
    "excellent":"#35d677",
    "all time":"#1fc45f",
    "closed":"#8fa3b8"
  }[k] ?? "#9fb3c9";
  return {pct, col, word: (r || "—")};
}

/* Flexible header resolver */
function buildFinder(fields){
  const lows = fields.map(f=>({raw:f, low:lower(f)}));
  return (cands)=>{
    const arr = Array.isArray(cands)?cands:[cands];
    for(const c of arr){ const ex = lows.find(o=> o.low === lower(c)); if(ex) return ex.raw; }
    for(const c of arr){ const ct = lows.find(o=> o.low.includes(lower(c))); if(ct) return ct.raw; }
    return null;
  };
}

/* --------- Main --------- */
async function main(){
  const resortQ = new URLSearchParams(location.search).get("resort") || "";
  const resp = await fetch(CSV_URL, {cache:"no-store"});
  const csv = await resp.text();
  const parsed = Papa.parse(csv,{header:true,skipEmptyLines:true});
  const fields = parsed.meta.fields || [];
  const rows = parsed.data || [];
  if(!fields.length || !rows.length){ alert("No data found in sheet."); return; }
  const find = buildFinder(fields);

  // Resolve headers we care about
  const H = {
    skiresort: find(["skiresort","resort","name"]),
    last24hr: find(["last24hr","last 24","24h","snow24"]),
    last72hr: find(["last72hr","last 72","72h","snow72"]),
    last7days: find(["last7days","last 7","7d"]),
    seasonsnow: find(["seasonsnow","season total","season inches","season"]),
    lat: find(["lat","latitude"]),
    lon: find(["lon","lng","longitude"]),
    openingday: find(["openingday","open","status"]),
    snow24h: find(["snow24h","next24h","today snow","d0"]),
    tmrsnow: find(["tmrsnow","tomorrow","d1"]),
    d3: find(["3snow","day2","d2"]),
    d4: find(["4snow","day3","d3"]),
    d5: find(["5snow","day4","d4"]),
    d6: find(["6snow","day5","d5"]),
    d7: find(["7snow","day6","d6"]),
  };

  // choose row
  let row = rows[0];
  if(resortQ && H.skiresort){
    const found = rows.find(r => lower(r[H.skiresort]) === lower(resortQ));
    if(found) row = found;
  }

  // Title + badge
  $("title").textContent = (H.skiresort && row[H.skiresort]) || "Ski Resort";
  const badge = $("badge");
  const rawOpen = (H.openingday && row[H.openingday]) ? String(row[H.openingday]).trim() : "";
  const isOpen = rawOpen.toUpperCase()==="OPEN" || rawOpen===""; // show OPEN if blank
  badge.textContent = isOpen ? "Open" : rawOpen;
  badge.classList.toggle("closed", !isOpen);

  // Recent snow
  const v24 = H.last24hr ? toNum(row[H.last24hr]) : 0;
  const v72 = H.last72hr ? toNum(row[H.last72hr]) : 0;
  const v7d = H.last7days ? toNum(row[H.last7days]) : 0;
  $("last24").textContent = nice(v24) + " in";
  $("last72").textContent = nice(v72) + " in";
  $("last7").textContent  = nice(v7d)  + " in";

  // Season hero (bigger)
  const season = H.seasonsnow ? toNum(row[H.seasonsnow]) : 0;
  $("seasonValue").textContent = nice(season) + " in";

  // Map
  const lat = H.lat ? toNum(row[H.lat]) : NaN;
  const lon = H.lon ? toNum(row[H.lon]) : NaN;
  if(!isNaN(lat) && !isNaN(lon) && Math.abs(lat)>0 && Math.abs(lon)>0){
    const map = L.map('map',{zoomControl:false}).setView([lat,lon], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18, attribution:'© OpenStreetMap'}).addTo(map);
    L.marker([lat,lon]).addTo(map).bindPopup((H.skiresort && row[H.skiresort])||"Resort");
    setTimeout(()=> map.invalidateSize(), 150);
  } else {
    $("map").innerHTML = '<div style="padding:12px;color:#9fb1c6">No coordinates found in sheet.</div>';
  }

  /* ---- 7 Day Outlook (baseline aligned) ---- */
  const snowSeq = [
    { key:H.snow24h, label:"Today" },
    { key:H.tmrsnow, label:"Tomorrow" },
    { key:H.d3, label:labelDate(2) },
    { key:H.d4, label:labelDate(3) },
    { key:H.d5, label:labelDate(4) },
    { key:H.d6, label:labelDate(5) },
    { key:H.d7, label:labelDate(6) },
  ].filter(x=> !!x.key);
  const snowVals = snowSeq.map(s => toNum(row[s.key]));
  const snowMax  = Math.max(6, ...snowVals);
  $("snowBars").innerHTML = snowSeq.map((s, i) => {
    const v = snowVals[i];
    const h = Math.max(6, (v / snowMax) * 220);
    return `
      <div class="barwrap">
        <div class="barbox">
          <div class="bar" style="height:${h}px"></div>
        </div>
        <div class="bar-label">${s.label}</div>
        <div class="bar-inch">${nice(v)} in</div>
      </div>
    `;
  }).join("");

  /* ---- 7 Day Stoke Rating ---- */
  const ratingLabels = [
    { slug:"today",    display:"Today" },
    { slug:"tomorrow", display:"Tomorrow" },
    { slug:isoDate(2), display:labelDate(2) },
    { slug:isoDate(3), display:labelDate(3) },
    { slug:isoDate(4), display:labelDate(4) },
    { slug:isoDate(5), display:labelDate(5) },
    { slug:isoDate(6), display:labelDate(6) },
  ];

  function buildFinder2(fields){ const lows = fields.map(f=>({raw:f, low:lower(f)})); return c=>{const arr=Array.isArray(c)?c:[c]; for(const k of arr){const ex=lows.find(o=>o.low===lower(k)); if(ex) return ex.raw;} for(const k of arr){const ct=lows.find(o=>o.low.includes(lower(k))); if(ct) return ct.raw;} return null;}; }
  const getField = (exactLower, cands) => {
    const exact = fields.find(h => lower(h) === exactLower);
    if (exact) return exact;
    const f = buildFinder2(fields);
    return f(cands) || null;
  };
  const getCell = (exactLower, fallbacks) => {
    const name = getField(exactLower, fallbacks);
    return name ? row[name] : "";
  };
  function legacyKeys(idx){
    if (idx===0) return { r:["rating_td","today rating"], s:["reason_td","today reason"] };
    if (idx===1) return { r:["rating_tmr","tomorrow rating"], s:["reason_tmr","tmr reason"] };
    const d = idx+1;
    return { r:[`rating_day${d}`, `day${d} rating`, `d${d} rating`],
             s:[`reason_day${d}`, `day${d} reason`, `d${d} why`] };
  }

  const stokeHtml = ratingLabels.map((lab, idx) => {
    let rating = getCell(`rating_${lab.slug}`, []);
    let reason = getCell(`reason_${lab.slug}`, []);
    if(!rating){
      const L = legacyKeys(idx);
      rating = getCell(`rating_${idx===0?'today':idx===1?'tomorrow':`day${idx+1}`}`, L.r);
      reason = getCell(`reason_${idx===0?'today':idx===1?'tomorrow':`day${idx+1}`}`, L.s);
    }

    // “closed until opening day” logic
    let closed = false;
    const rawOpenVal = (H.openingday && row[H.openingday]) ? String(row[H.openingday]).trim() : "";
    if(rawOpenVal && rawOpenVal.toUpperCase()!=="OPEN"){
      const opDate = new Date(rawOpenVal);
      if(!isNaN(opDate)){
        const thisDate = (idx===0) ? new Date() : (idx===1) ? new Date(Date.now()+86400000) : new Date(lab.slug+"T00:00:00");
        const opMid = new Date(opDate.toISOString().slice(0,10)+"T00:00:00");
        if(thisDate < opMid) closed = true;
      }
    } else if(!rawOpenVal){ closed = true; }

    const meta = ratingMeta(closed ? "closed" : rating);
    const h = Math.max(8, (meta.pct/100) * 220);
    const col = meta.col;
    return `
      <div class="barwrap">
        <div class="barbox">
          <div class="sbar" style="height:${h}px; background:linear-gradient(180deg, ${col}c0, ${col}22)"></div>
        </div>
        <div class="bar-label">${lab.display}</div>
        <div class="rating-text">${(meta.word||'').toString().split(' ').map(w=> w? (w[0].toUpperCase()+w.slice(1)) : '').join(' ')}</div>
        <div class="reason">${(reason||"").toString()}</div>
      </div>
    `;
  }).join("");
  $("stokeBars").innerHTML = stokeHtml;
}

window.addEventListener('load', main);
</script>
</body>
</html>
