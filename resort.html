<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Snow Signal — Resort</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#070b12;           /* deep night */
    --bg2:#0e1623;          /* panel background */
    --glass:rgba(255,255,255,.06);
    --glass-brd:rgba(255,255,255,.12);
    --text:#e6eef7;
    --muted:#9fb1c6;
    --accent:#7cc9ff;       /* Surfline-y blue */
    --accent2:#6ee7b7;      /* mint */
    --danger:#ef4444;
    --ok:#22c55e;
    --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background: radial-gradient(1200px 800px at 10% -20%, #162238 0%, transparent 60%),
                radial-gradient(1000px 800px at 120% 20%, #0c1422 0%, transparent 55%),
                linear-gradient(180deg, #0a1220 0%, #070b12 60%);
    background-attachment: fixed;
    overflow-x:hidden;
  }
  /* subtle animated noise */
  .noise{position:fixed;inset:-20%;pointer-events:none;opacity:.06;mix-blend-mode:overlay;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="4"/><feColorMatrix type="saturate" values="0"/></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');animation:grain 7s steps(10) infinite;}
  @keyframes grain{0%{transform:translate(0,0)}10%{transform:translate(-2%, -1%)}20%{transform:translate(-1%, 1%)}30%{transform:translate(1%, -2%)}40%{transform:translate(2%,1%)}50%{transform:translate(-1%,2%)}60%{transform:translate(1%,-1%)}70%{transform:translate(0,2%)}80%{transform:translate(-2%,0)}90%{transform:translate(2%,-1%)}100%{transform:translate(0,0)}}

  .wrap{max-width:1200px;margin:42px auto;padding:0 20px 64px}

  /* HEADER */
  header{display:flex;align-items:center;justify-content:space-between;gap:20px;margin-bottom:18px}
  .brand{display:flex;align-items:baseline;gap:16px}
  h1{margin:0;font-size:44px;letter-spacing:.3px;line-height:1.05;font-weight:900}
  .subtitle{font-size:14px;color:var(--muted)}

  .status{display:flex;gap:12px;align-items:center}
  .badge{padding:8px 14px;border-radius:999px;font-size:14px;font-weight:800;letter-spacing:.8px;text-transform:uppercase;background:var(--glass);border:1px solid var(--glass-brd);backdrop-filter: blur(8px);}
  .badge.open{background:linear-gradient(180deg, rgba(34,197,94,.15), rgba(34,197,94,.05));border-color:rgba(34,197,94,.4);color:#dcfce7;box-shadow:0 0 0 0 rgba(34,197,94,.4);animation:pulse 2.5s infinite}
  .badge.closed{background:linear-gradient(180deg, rgba(239,68,68,.18), rgba(239,68,68,.06));border-color:rgba(239,68,68,.4);color:#fee2e2}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(34,197,94,.4)}70%{box-shadow:0 0 0 22px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}
  .updated{color:var(--muted);font-size:13px}

  /* GRID */
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:24px}
  @media (max-width:1000px){.grid{grid-template-columns:1fr}}

  /* PANELS */
  .panel{position:relative;background:var(--glass);border:1px solid var(--glass-brd);border-radius:18px;padding:20px 20px 16px;box-shadow:0 10px 30px rgba(0,0,0,.25);backdrop-filter: blur(8px)}
  .panel h2{font-size:16px;letter-spacing:.8px;text-transform:uppercase;font-weight:800;color:#cfe5ff;margin:2px 0 10px;display:flex;align-items:center;gap:10px}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .chip{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid var(--glass-brd);color:#cfe5ff}

  /* SNOW STATS */
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:4px 0 16px}
  .stat{background:linear-gradient(180deg, rgba(124,201,255,.08), rgba(124,201,255,.03));border:1px solid rgba(124,201,255,.18);border-radius:14px;padding:14px 14px 12px}
  .stat .k{font-size:13px;color:#b7c9de;text-transform:uppercase;letter-spacing:.8px}
  .stat .v{margin-top:6px;font-size:28px;font-weight:900}
  @media (max-width:600px){.stats{grid-template-columns:1fr}}

  /* 7-DAY BARS */
  .bars{display:flex;align-items:flex-end;gap:14px;flex-wrap:nowrap;overflow:auto;padding-bottom:10px;margin-top:10px}
  .barwrap{position:relative;display:flex;flex-direction:column;align-items:center;gap:8px;min-width:78px}
  .bar{width:68px;border-radius:12px 12px 0 0;background:linear-gradient(180deg, rgba(124,201,255,.5), rgba(124,201,255,.1));border:1px solid rgba(124,201,255,.35);box-shadow:0 8px 24px rgba(124,201,255,.18), inset 0 -10px 20px rgba(255,255,255,.06);transition:transform .2s ease, box-shadow .2s ease, background .2s ease}
  .barwrap:hover .bar{transform:translateY(-6px);box-shadow:0 10px 28px rgba(124,201,255,.28), inset 0 -12px 24px rgba(255,255,255,.08)}
  .bar-lbl{font-size:12px;color:#b7c9de}
  .bar-inch{font-size:14px;font-weight:800}

  /* TOOLTIP */
  .tip{position:absolute;bottom:100%;transform:translateY(-8px);background:#0b1422;border:1px solid var(--glass-brd);padding:10px 12px;border-radius:12px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .15s ease;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .barwrap:hover .tip{opacity:1}

  /* RATINGS – circular gauges */
  .ratings{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  @media (max-width:820px){.ratings{grid-template-columns:1fr}}
  .rate{display:flex;flex-direction:column;align-items:center;gap:10px;padding:14px;background:linear-gradient(180deg, rgba(110,231,183,.08), rgba(110,231,183,.03));border:1px solid rgba(110,231,183,.16);border-radius:16px}
  .cap{font-size:12px;color:#b7c9de;text-transform:uppercase;letter-spacing:.8px}
  .rtext{font-size:18px;font-weight:900;letter-spacing:.3px}
  .reason{font-size:14px;color:var(--muted);text-align:center;min-height:22px}

  .gauge{width:160px;height:160px;display:block}
  .g-wrap{position:relative}
  .g-label{position:absolute;inset:0;display:grid;place-items:center;font-weight:900;font-size:28px}

  /* FOOTER */
  footer{margin-top:26px;color:var(--muted);font-size:12px;text-align:center}
  a{color:var(--accent)}
</style>
</head>
<body>
<div class="noise"></div>
<div class="wrap">
  <header>
    <div class="brand">
      <h1 id="title">Ski Resort</h1>
      <div class="subtitle" id="subtitle">7‑day outlook • live stoke</div>
    </div>
    <div class="status">
      <span class="badge" id="openBadge">—</span>
      <span class="updated" id="updated"></span>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT: Snow / Bars -->
    <section class="panel">
      <h2>Snow Overview</h2>
      <div class="stats">
        <div class="stat"><div class="k">Season Snowfall</div><div class="v" id="season">—</div></div>
        <div class="stat"><div class="k">Last 24 Hours</div><div class="v" id="last24">—</div></div>
        <div class="stat"><div class="k">Last 72 Hours</div><div class="v" id="last72">—</div></div>
      </div>
      <div class="chips" id="chips"></div>
      <div class="bars" id="bars"></div>
    </section>

    <!-- RIGHT: Ratings -->
    <section class="panel">
      <h2>Stoke Rating</h2>
      <div class="ratings">
        <div class="rate">
          <div class="g-wrap">
            <svg class="gauge" viewBox="0 0 120 120"><circle cx="60" cy="60" r="52" stroke="rgba(255,255,255,.08)" stroke-width="12" fill="none"/><circle id="g-td" cx="60" cy="60" r="52" stroke-dasharray="326" stroke-dashoffset="326" stroke-linecap="round" stroke-width="12" fill="none"/></svg>
            <div class="g-label" id="gtext-td">—</div>
          </div>
          <div class="cap">Today</div>
          <div class="rtext" id="rt-td">—</div>
          <div class="reason" id="rs-td"></div>
        </div>

        <div class="rate">
          <div class="g-wrap">
            <svg class="gauge" viewBox="0 0 120 120"><circle cx="60" cy="60" r="52" stroke="rgba(255,255,255,.08)" stroke-width="12" fill="none"/><circle id="g-tmr" cx="60" cy="60" r="52" stroke-dasharray="326" stroke-dashoffset="326" stroke-linecap="round" stroke-width="12" fill="none"/></svg>
            <div class="g-label" id="gtext-tmr">—</div>
          </div>
          <div class="cap">Tomorrow</div>
          <div class="rtext" id="rt-tmr">—</div>
          <div class="reason" id="rs-tmr"></div>
        </div>

        <div class="rate">
          <div class="g-wrap">
            <svg class="gauge" viewBox="0 0 120 120"><circle cx="60" cy="60" r="52" stroke="rgba(255,255,255,.08)" stroke-width="12" fill="none"/><circle id="g-d3" cx="60" cy="60" r="52" stroke-dasharray="326" stroke-dashoffset="326" stroke-linecap="round" stroke-width="12" fill="none"/></svg>
            <div class="g-label" id="gtext-d3">—</div>
          </div>
          <div class="cap">Day 3</div>
          <div class="rtext" id="rt-d3">—</div>
          <div class="reason" id="rs-d3"></div>
        </div>
      </div>
    </section>
  </div>

  <footer>
    Powered by <strong>Snow Signal</strong> • Use <code>?resort=Your Resort Name</code> in the URL
  </footer>
</div>

<!-- Papa Parse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const CSV_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-1vTGijpvcmz6TA1HWmDc4njQx7vS0gZ4WSfUrw2EgLT9_aVOX3LFfyIL3datSI9gVswmUadZuHoGx6Hw/pub?output=csv`;
const NEED = {
  skiresort:"skiresort",
  seasonsnow:"seasonsnow", last24hr:"last24hr", last72hr:"last72hr",
  snow24h:"snow24h", tmrsnow:"tmrsnow","3snow":"3snow","4snow":"4snow","5snow":"5snow","6snow":"6snow","7snow":"7snow",
  openingday:"openingday",
  rating_td:"rating_td", rating_tmr:"rating_tmr", rating_day3:"rating_day3",
  reason_td:"reason_td", reason_tmr:"reason_tmr", reason_day3:"reason_day3"
};
const $ = id=>document.getElementById(id);
const lower=s=> (s??"").toString().trim().toLowerCase();
const toNum=v=>{const m=String(v??"").replace(","," ").match(/-?\d+(\.\d+)?/);return m?Number(m[0]):0};
const nice=n=> isFinite(n)? (Math.abs(n) >= 100 ? n.toFixed(0) : n.toFixed(1)) : "0";
const dPlus=i=> new Date(Date.now()+i*86400000).toLocaleDateString(undefined,{month:"short",day:"numeric"});

/* Map ratings to % + color */
function ratingStyle(r){
  const key = lower(r);
  const pct = {"poor":18,"fair":42,"good":68,"excellent":88,"all time":100}[key] ?? 0;
  const col = {"poor":"#ef4444","fair":"#f59e0b","good":"#84cc16","excellent":"#22c55e","all time":"#16a34a"}[key] ?? "#94a3b8";
  return {pct, col};
}
function setBadge(status){
  const badge = $("openBadge");
  const up = $("updated");
  const s = (status||"").toString().trim().toUpperCase();
  const open = s === "OPEN";
  badge.textContent = open? "OPEN" : (s||"STATUS N/A");
  badge.className = "badge "+(open?"open":"closed");
  up.textContent = "Updated "+ new Date().toLocaleString();
}

/* Draw circular gauge (326 ≈ circumference for r=52) */
function drawGauge(id, pct, col){
  const c = $(id); if(!c) return;
  const circumference = 2*Math.PI*52; // 326.72
  const offset = circumference * (1 - Math.max(0, Math.min(100,pct))/100);
  c.style.stroke = col; c.style.filter = `drop-shadow(0 4px 14px ${col}55)`;
  c.style.transition = "stroke-dashoffset .8s ease";
  c.setAttribute("stroke-dasharray", circumference.toFixed(2));
  c.setAttribute("stroke-dashoffset", circumference.toFixed(2));
  requestAnimationFrame(()=>{ c.setAttribute("stroke-dashoffset", offset.toFixed(2)); });
}

function setRating(prefix, rating, reason){
  const {pct,col} = ratingStyle(rating);
  drawGauge("g-"+prefix, pct, col);
  $("gtext-"+prefix).textContent = Math.round(pct)+"%";
  $("rt-"+prefix).textContent = rating ? rating.replace(/\b\w/g,c=>c.toUpperCase()) : "—";
  $("rs-"+prefix).textContent = reason || "";
}

function chip(txt){
  const el = document.createElement('span');
  el.className = 'chip';
  el.textContent = txt;
  return el;
}

async function main(){
  const resortQ = new URLSearchParams(location.search).get("resort") || "";
  $("subtitle").textContent = resortQ? `7‑day outlook for ${resortQ}` : "7‑day outlook • live stoke";
  if(!resortQ){
    $("updated").textContent = "Add ?resort=Name to the URL";
  }

  const resp = await fetch(CSV_URL, {cache:"no-store"});
  const csv  = await resp.text();
  const parsed = Papa.parse(csv,{header:true,skipEmptyLines:true});

  // Case-insensitive header map
  const fields = parsed.meta.fields || [];
  const hmap = {}; fields.forEach(h=> hmap[lower(h)] = h);
  const H={}; for(const [k,w] of Object.entries(NEED)) H[k] = hmap[lower(w)] || null;

  const rows = parsed.data || [];
  const row = rows.find(r => H.skiresort && lower(r[H.skiresort]) === lower(resortQ)) || rows[0] || null;
  if(!row){ alert("No data rows present in sheet."); return; }

  $("title").textContent = row[H.skiresort] || resortQ || "Ski Resort";
  setBadge(H.openingday ? row[H.openingday] : "");

  // Left stats
  const season = H.seasonsnow ? toNum(row[H.seasonsnow]) : 0;
  const l24    = H.last24hr   ? toNum(row[H.last24hr])    : 0;
  const l72    = H.last72hr   ? toNum(row[H.last72hr])    : 0;
  $("season").textContent = nice(season)+" in";
  $("last24").textContent = nice(l24)+" in";
  $("last72").textContent = nice(l72)+" in";

  // Chips summary
  const chips = $("chips"); chips.innerHTML='';
  chips.append(
    chip(`Next 24h: ${nice(H.snow24h? toNum(row[H.snow24h]) : 0)} in`),
    chip(`Tomorrow: ${nice(H.tmrsnow? toNum(row[H.tmrsnow]) : 0)} in`),
    chip(`3‑Day Total: ${nice((H.snow24h?toNum(row[H.snow24h]):0)+(H.tmrsnow?toNum(row[H.tmrsnow]):0)+(H["3snow"]?toNum(row[H["3snow"]]):0))} in`)
  );

  // 7‑day bars (Next 24h + D1..D6)
  const seq = [
    {key:H.snow24h, label:"Next 24h"},
    {key:H.tmrsnow, label:dPlus(1)},
    {key:H["3snow"], label:dPlus(2)},
    {key:H["4snow"], label:dPlus(3)},
    {key:H["5snow"], label:dPlus(4)},
    {key:H["6snow"], label:dPlus(5)},
    {key:H["7snow"], label:dPlus(6)},
  ].filter(s=>!!s.key);
  const vals = seq.map(s=> toNum(row[s.key]));
  const max  = Math.max(6, ...vals);
  $("bars").innerHTML = seq.map((s,i)=>{
    const v = vals[i], h = (v/max)*220; // taller bars
    const tip = `${s.label} — ${nice(v)} in`;
    return `<div class="barwrap">
      <div class="bar" style="height:${h}px"></div>
      <div class="tip">${tip}</div>
      <div class="bar-lbl">${s.label}</div>
      <div class="bar-inch">${nice(v)} in</div>
    </div>`;
  }).join('');

  // Ratings
  setRating('td',  (H.rating_td  ? row[H.rating_td]  : ''), (H.reason_td  ? row[H.reason_td]  : ''));
  setRating('tmr', (H.rating_tmr ? row[H.rating_tmr] : ''), (H.reason_tmr ? row[H.reason_tmr] : ''));
  setRating('d3',  (H.rating_day3? row[H.rating_day3]: ''), (H.reason_day3? row[H.reason_day3]: ''));
}
window.addEventListener('load', main);
</script>
</body>
</html>
