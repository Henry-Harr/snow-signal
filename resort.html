<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Snow Signal — Resort</title>
<style>
  :root{--bg:#0b0f14;--panel:#111923;--text:#e3eef7;--muted:#9fb1c6;--chip:#182333;--border:#203043;--track:#223144}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:900px;margin:32px auto;padding:0 16px}
  a{color:#8cc0ff;text-decoration:none}
  header{display:flex;gap:12px;align-items:baseline;justify-content:space-between;margin-bottom:10px}
  h1{margin:0;font-size:22px}
  .muted{color:var(--muted);font-size:13px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#cfe0f2}
  .row{display:grid;grid-template-columns:120px 1fr;align-items:center;gap:12px;margin:12px 0}
  .label{font-weight:700;font-size:13px;color:#d6e1ee;text-transform:uppercase;letter-spacing:.04em}
  .track{background:var(--track);height:16px;border-radius:999px;position:relative;overflow:hidden;border:1px solid var(--border)}
  .fill{height:100%;width:0%;transition:width .55s ease}
  .tag{position:absolute;right:8px;top:-18px;font-size:11px;color:var(--muted)}
  .back{margin-bottom:12px;display:inline-block}
  .err{color:#ffb4b4;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <a class="back" href="index.html">← Back to search</a>
  <header>
    <h1 id="title">Resort</h1>
    <div id="subtitle" class="muted"></div>
  </header>

  <div class="panel">
    <div id="meta" class="chips"></div>
    <div id="bars"></div>
    <div id="msg" class="muted" style="margin-top:10px">Loading…</div>
    <div id="err" class="err"></div>
  </div>
</div>

<!-- Papa Parse for safe CSV parsing -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
<script>
/* ====== CONFIG: set your published CSV URL & headers ====== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGijpvcmz6TA1HWmDc4njQx7vS0gZ4WSfUrw2EgLT9_aVOX3LFfyIL3datSI9gVswmUadZuHoGx6Hw/pub?output=csv"; 
// Example format:
// https://docs.google.com/spreadsheets/d/e/XXXX/pub?gid=0&single=true&output=csv
const COLS = {
  resort:    "skiresort",
  today:     "rating_td",
  tomorrow:  "rating_tmr",
  reasonTd:  "reason_td",    // optional
  reasonTmr: "reason_tmr"    // optional
};
/* ========================================================== */

const ratingMap = {
  "poor":      {score:20,  color:"#d32f2f"},
  "fair":      {score:40,  color:"#fb8c00"},
  "good":      {score:65,  color:"#fdd835"},
  "excellent": {score:85,  color:"#43a047"},
  "all time":  {score:100, color:"#1e88e5"},
  "open":      {score:80,  color:"#2e7d32"},
  "closed":    {score:10,  color:"#9e9e9e"}
};

const $ = id => document.getElementById(id);
const lower = s => (s||"").toString().trim().toLowerCase();

function makeBar(label, rating, reason, metaEl){
  const meta = ratingMap[lower(rating)] || {score:0,color:"#6b7c92"};
  const row=document.createElement("div"); row.className="row";
  const lbl=document.createElement("div"); lbl.className="label"; lbl.textContent=label;
  const track=document.createElement("div"); track.className="track";
  const fill=document.createElement("div"); fill.className="fill";
  fill.style.width = Math.max(4, meta.score) + "%";
  fill.style.background = meta.color;
  const tag=document.createElement("div"); tag.className="tag"; tag.textContent=(rating||"—").toUpperCase();
  track.append(fill,tag); row.append(lbl,track);
  if (reason){
    const chip=document.createElement("span"); chip.className="chip"; chip.textContent=reason;
    metaEl.appendChild(chip);
  }
  return row;
}

function onError(txt){ $("err").textContent = txt; $("msg").textContent=""; }

async function loadResort(){
  const resortParam = new URLSearchParams(location.search).get("resort");
  const resortQ = resortParam ? decodeURIComponent(resortParam) : "";
  $("title").textContent = `Snow Signal — ${resortQ||"Resort"}`;
  $("subtitle").textContent = resortQ || "No resort selected";
  if(!resortQ){ $("msg").textContent = "Choose a resort from the search page."; return; }

  try{
    // fetch CSV
    const res = await fetch(CSV_URL, { method:"GET", cache:"no-store" });
    if(!res.ok) throw new Error("Sheet fetch failed: " + res.status);
    const csvText = await res.text();

    // parse CSV
    const parsed = Papa.parse(csvText, { header:true, skipEmptyLines:true });
    if (parsed.errors && parsed.errors.length) console.warn(parsed.errors);
    const rows = parsed.data;
    if(!rows || !rows.length){ $("msg").textContent = "No data."; return; }

    // map headers (case-insensitive)
    const fields = parsed.meta.fields || [];
    const findHdr = want => fields.find(h => lower(h) === lower(want));
    const H = {
      resort: findHdr(COLS.resort),
      today:  findHdr(COLS.today),
      tmr:    findHdr(COLS.tomorrow),
      rTd:    findHdr(COLS.reasonTd),
      rTmr:   findHdr(COLS.reasonTmr)
    };
    if(!H.resort || !H.today || !H.tmr){
      onError(`Missing headers. Need at least: ${COLS.resort}, ${COLS.today}, ${COLS.tomorrow}`); 
      return;
    }

    // find the matching row
    const rec = rows.find(r => lower(r[H.resort]) === lower(resortQ));
    if(!rec){ $("msg").textContent = `No row found for "${resortQ}".`; return; }

    // render
    $("subtitle").textContent = rec[H.resort] || resortQ;
    const ratingTD  = (rec[H.today] || "").toString().trim();
    const ratingTMR = (rec[H.tmr]   || "").toString().trim();
    const reasonTD  = H.rTd  ? (rec[H.rTd]  || "").toString().trim() : "";
    const reasonTMR = H.rTmr ? (rec[H.rTmr] || "").toString().trim() : "";

    const metaEl = $("meta"), barsEl = $("bars");
    metaEl.innerHTML = ""; barsEl.innerHTML = "";
    const chip = document.createElement("span"); chip.className="chip"; chip.textContent = rec[H.resort] || resortQ; 
    metaEl.appendChild(chip);

    barsEl.appendChild(makeBar("Today",    ratingTD,  reasonTD,  metaEl));
    barsEl.appendChild(makeBar("Tomorrow", ratingTMR, reasonTMR, metaEl));

    $("msg").textContent = "";
  }catch(err){
    console.error(err);
    onError("Failed to load sheet. Ensure the link is a published CSV (output=csv) and accessible.");
  }
}

window.addEventListener("load", loadResort);
</script>
</body>
</html>
