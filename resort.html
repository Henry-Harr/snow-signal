<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
/* ======== Robust CSV loader with fuzzy header mapping + inline debug ======== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGijpvcmz6TA1HWmDc4njQx7vS0gZ4WSfUrw2EgLT9_aVOX3LFfyIL3datSI9gVswmUadZuHoGx6Hw/pub?output=csv";

/* Accept common header variations so you don't have to match exact spellings */
const NEED = {
  skiresort:   ["skiresort","resort","name"],
  seasonsnow:  ["seasonsnow","season snow","season_total","season","season inches"],
  last24hr:    ["last24hr","24h","last 24","snow24","snow_24","24hr"],
  last72hr:    ["last72hr","72h","last 72","snow72","snow_72","72hr"],
  snow24h:     ["snow24h","next24h","next 24","d0","today snow"],
  tmrsnow:     ["tmrsnow","tomorrow","d1","day1"],
  "3snow":     ["3snow","d2","day2"],
  "4snow":     ["4snow","d3","day3"],
  "5snow":     ["5snow","d4","day4"],
  "6snow":     ["6snow","d5","day5"],
  "7snow":     ["7snow","d6","day6"],
  openingday:  ["openingday","status","open","operating"],
  rating_td:   ["rating_td","today rating","today"],
  rating_tmr:  ["rating_tmr","tomorrow rating","tmr rating"],
  rating_day3: ["rating_day3","day3 rating","d3 rating"],
  reason_td:   ["reason_td","today reason","today why"],
  reason_tmr:  ["reason_tmr","tmr reason","tomorrow why"],
  reason_day3: ["reason_day3","day3 reason","d3 why"]
};

const $ = id => document.getElementById(id);
const lower = s => (s ?? "").toString().trim().toLowerCase();
const toNum = v => { const m = String(v ?? "").replace(/,/g,"").match(/-?\d+(\.\d+)?/); return m ? Number(m[0]) : 0; };
const nice  = n => (isFinite(n) ? (Math.abs(n) >= 100 ? n.toFixed(0) : n.toFixed(1)) : "0");
const dPlus = i => new Date(Date.now()+i*86400000).toLocaleDateString(undefined,{month:"short",day:"numeric"});

/* UI helpers (updated per your request) */
function setBadge(status){
  const badge = $("openBadge");
  const up = $("updated");
  const s = (status||"").toString().trim().toUpperCase();
  const open = s === "OPEN";
  badge.textContent = open ? "OPEN" : (s || "STATUS N/A");
  badge.className = "badge " + (open ? "open" : "closed");
  up.textContent = "Powered by Pow Signal";
}
function drawBar(id, pct, col){
  const el = document.getElementById(id); if(!el) return;
  el.style.background = `linear-gradient(90deg, ${col}, var(--accent2))`;
  el.style.width = '0%';
  requestAnimationFrame(()=>{ el.style.width = Math.max(0, Math.min(100, pct)) + '%'; });
}
function setRating(prefix, rating, reason){
  const key = lower(rating||'');
  const pctMap = {poor:18,fair:42,good:68,excellent:88,"all time":100};
  const colMap = {poor:'#ef4444',fair:'#f59e0b',good:'#84cc16',excellent:'#22c55e','all time':'#16a34a'};
  const pct = pctMap[key] ?? 0;
  const col = colMap[key] ?? '#94a3b8';
  drawBar('g-'+prefix, pct, col);
  $("gtext-"+prefix).textContent = pct ? Math.round(pct)+"%" : "—";
  $("rt-"+prefix).textContent = rating ? rating.replace(/\b\w/g,c=>c.toUpperCase()) : "—";
  $("rs-"+prefix).textContent = reason || "";
}

/* Tiny inline debug line so you don't have to open DevTools */
function debug(msg){
  const d = document.createElement('div');
  d.style.marginTop='8px'; d.style.color='#9fb1c6'; d.style.fontSize='12px';
  d.textContent = msg; document.body.appendChild(d);
}

async function main(){
  try{
    const resortQ = new URLSearchParams(location.search).get("resort") || "";

    const resp = await fetch(CSV_URL, {cache:"no-store"});
    if(!resp.ok){ debug(`Fetch error: ${resp.status} ${resp.statusText}`); return; }
    const csv = await resp.text();

    const parsed = Papa.parse(csv,{header:true,skipEmptyLines:true,transformHeader:h=>String(h||'').trim()});
    const fields = parsed.meta.fields || [];
    if(!fields.length){ debug("No headers found in CSV. Is the sheet 'Published to the web'?"); return; }

    const lowers = fields.map(f=>({raw:f, low:lower(f)}));
    const findHeader = (cands)=>{
      const arr = Array.isArray(cands)?cands:[cands];
      for(const c of arr){ const ex = lowers.find(o=>o.low===lower(c)); if(ex) return ex.raw; }
      for(const c of arr){ const ct = lowers.find(o=>o.low.includes(lower(c))); if(ct) return ct.raw; }
      return null;
    };

    const H = {}; for(const [k,c] of Object.entries(NEED)) H[k] = findHeader(c);

    const rows = parsed.data || [];
    if(!rows.length){ debug("CSV parsed but contains 0 data rows."); return; }

    let row = null;
    if(resortQ && H.skiresort) row = rows.find(r => lower(r[H.skiresort]) === lower(resortQ));
    if(!row) row = rows[0];

    $("title").textContent = (H.skiresort && row[H.skiresort]) || resortQ || "Ski Resort";
    setBadge(H.openingday ? row[H.openingday] : "");

    const get = h => h ? row[h] : null;

    /* Left stats */
    $("season").textContent = H.seasonsnow && get(H.seasonsnow)!=null ? `${nice(toNum(get(H.seasonsnow)))} in` : "—";
    $("last24").textContent = H.last24hr   && get(H.last24hr)!=null     ? `${nice(toNum(get(H.last24hr)))} in`   : "—";
    $("last72").textContent = H.last72hr   && get(H.last72hr)!=null     ? `${nice(toNum(get(H.last72hr)))} in`   : "—";

    /* 7-day bars */
    const seq = [
      {key:H.snow24h, label:"Next 24h"},
      {key:H.tmrsnow, label:dPlus(1)},
      {key:H["3snow"], label:dPlus(2)},
      {key:H["4snow"], label:dPlus(3)},
      {key:H["5snow"], label:dPlus(4)},
      {key:H["6snow"], label:dPlus(5)},
      {key:H["7snow"], label:dPlus(6)},
    ].filter(s => !!s.key);

    const vals = seq.map(s => toNum(get(s.key)));
    const max  = Math.max(6, ...vals);
    $("bars").innerHTML = seq.map((s,i)=>{
      const v = vals[i], h = (v/max)*200;
      return `<div class="barwrap">
        <div class="bar" style="height:${h}px"></div>
        <div class="bar-lbl">${s.label}</div>
        <div class="bar-inch">${nice(v)} in</div>
      </div>`;
    }).join("");

    /* Ratings */
    setRating("td",  H.rating_td  ? get(H.rating_td)  : "", H.reason_td  ? get(H.reason_td)  : "");
    setRating("tmr", H.rating_tmr ? get(H.rating_tmr) : "", H.reason_tmr ? get(H.reason_tmr) : "");
    setRating("d3",  H.rating_day3? get(H.rating_day3): "", H.reason_day3? get(H.reason_day3): "");

    /* Quick info line */
    const heads = fields.join(", ");
    debug(`Loaded ${rows.length} rows • Headers: ${heads}`);
    if(resortQ && H.skiresort && lower(row[H.skiresort]) !== lower(resortQ)){
      debug(`Resort "${resortQ}" not found. Showing: ${row[H.skiresort]||"Unknown"}`);
    }
  }catch(err){
    debug("Runtime error: " + (err?.message || err));
  }
}
window.addEventListener("load", main);
</script>
